{
  "version": 3,
  "sources": ["ieeevisdb.ts", "youtubeplayer.ts", "videoplayer.ts", "main.ts"],
  "sourcesContent": ["import {Session} from \"./session\";\n\ndeclare var firebase;\n\nexport class IeeeVisDb {\n    private sessionRef: FirebaseRef;\n\n    constructor(private SESSION_ID: string, private onData: (session: Session) => void) {\n        this.initFirebase();\n    }\n\n    initFirebase() {\n        firebase.initializeApp({\n            apiKey: \"AIzaSyCfFQ-eN52od55QBFZatFImgZgEDHK_P4E\",\n            authDomain: \"ieeevis.firebaseapp.com\",\n            databaseURL: \"https://ieeevis-default-rtdb.firebaseio.com\",\n            projectId: \"ieeevis\",\n            storageBucket: \"ieeevis.appspot.com\",\n            messagingSenderId: \"542997735159\",\n            appId: \"1:542997735159:web:6d9624111ec276a61fd5f2\",\n            measurementId: \"G-SNC8VC6RFM\"\n        });\n        firebase.analytics();\n    }\n\n    loadData() {\n        this.sessionRef = firebase.database().ref('sessions/' + this.SESSION_ID) as FirebaseRef;\n\n        this.sessionRef.on('value', (snapshot) => {\n            this.onData(snapshot.val() as Session);\n        });\n    }\n\n    set(path: string, value: string|number|{}) {\n        this.sessionRef.child(path).set(value);\n    }\n}\n\ninterface FirebaseRef {\n    child: (childName: string) => FirebaseRef;\n    set: (value: string|number|{}) => void;\n    on: (event: \"value\", cb: (data: any) => void) => void;\n}", "export interface YoutubePlayer {\n    playVideo: () => void;\n    //playVideoAt: (time: number) => void;\n    pauseVideo: () => void;\n    loadVideoById: (videoId: string, startTime?: number, size?: string) => void;\n    mute: () => void;\n    unMute: () => void;\n    seekTo: (timeS: number, allowSeekAhead: boolean) => void;\n    getDuration: () => number;\n    getCurrentTime: () => number;\n    setSize(width: number, height: number): void;\n}\n\nexport enum PlayerState {\n    UNSTARTED = -1,\n    ENDED = 0,\n    PLAYING = 1,\n    PAUSED = 2,\n    BUFFERING = 3,\n    CUED = 5\n}", "import {PlayerState, YoutubePlayer} from \"./youtubeplayer\";\nimport {Video, SessionStatus} from \"./session\";\n\ndeclare var YT;\n\nexport class IeeeVisVideoPlayer {\n    player: YoutubePlayer;\n    audioContext = new AudioContext();\n\n    private width = 400;\n    private height = 300;\n\n    youtubeApiReady = false;\n    youtubePlayerLoaded = false;\n    youtubePlayerReady = false;\n\n    constructor(private elementId: string,\n                private getCurrentVideo: () => Video,\n                private getCurrentVideoId: () => string,\n                private getCurrentVideoStatus: () => SessionStatus) {\n        this.init();\n    }\n\n    onYouTubeIframeAPIReady() {\n        this.youtubeApiReady = true;\n    }\n\n    updateVideo() {\n        if(!this.getCurrentVideoId() || !this.youtubeApiReady) {\n            return;\n        }\n\n        if(!this.youtubePlayerLoaded) {\n            this.loadYoutubePlayer();\n        } else {\n            this.changeYoutubeVideo();\n        }\n    }\n\n    setSize(width: number, height: number) {\n        this.width = width;\n        this.height = height;\n\n        if(!this.player) {\n            return;\n        }\n        this.player.setSize(width, height);\n    }\n\n    private init() {\n        const tag = document.createElement('script');\n        tag.src = \"https://www.youtube.com/iframe_api\";\n        const firstScriptTag = document.getElementsByTagName('script')[0];\n        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);\n    }\n\n    private onPlayerReady() {\n        console.log('player ready', this.player);\n        this.youtubePlayerReady = true;\n\n        if(this.audioContext.state === \"suspended\") {\n            this.player.mute();\n        }\n        this.player.playVideo();\n    }\n\n    private onPlayerStateChange(state: {target: YoutubePlayer, data: PlayerState}) {\n        if(state.data === PlayerState.UNSTARTED) {\n            // This is to force the player to go to 0 because it does not recognize 0 as a start time in loadVideoById.\n            this.player.seekTo(this.getCurrentStartTimeS(), true);\n        }\n\n        if(state.data === PlayerState.PLAYING || state.data === PlayerState.BUFFERING) {\n            const startTime = this.getCurrentStartTimeS();\n            const currentTime = this.player.getCurrentTime();\n            if(Math.abs(startTime - currentTime) > 5) {\n                this.player.seekTo(this.getCurrentStartTimeS(), true);\n                console.log('lagging behind. seek.', this.getCurrentStartTimeS(), this.player.getCurrentTime());\n            }\n        }\n    }\n\n    private loadYoutubePlayer() {\n        this.youtubePlayerLoaded = true;\n\n        this.player = new YT.Player(this.elementId, {\n            width: this.width,\n            height: this.height,\n            videoId: this.getCurrentVideoId(),\n\n            playerVars: {\n                'playsinline': 1,\n                'autoplay': 1,\n                'controls': 1,\n                'rel': 0,\n                'modestbranding': 1,\n                'mute': 0,\n                start: this.getCurrentStartTimeS(),\n            },\n            events: {\n                'onReady': this.onPlayerReady.bind(this),\n                'onStateChange': this.onPlayerStateChange.bind(this),\n            }\n        });\n    }\n\n    private changeYoutubeVideo() {\n        // The seeking in the following line does not work for 0 (see workaround above).\n        this.player.loadVideoById(this.getCurrentVideoId(), this.getCurrentStartTimeS());\n        this.player.playVideo();\n    }\n\n    private getCurrentStartTimeS() {\n        if(this.getCurrentVideo().type === 'prerecorded' || !this.youtubePlayerReady) {\n            const timeMs = new Date().getTime();\n            const videoStartTimestampMs = this.getCurrentVideoStatus()?.videoStartTimestamp;\n\n            return Math.round((timeMs - videoStartTimestampMs) / 1000);\n        } else if(this.getCurrentVideo().type === 'live') {\n            return this.player.getDuration();\n        }\n    }\n}", "import {Session, SessionState, Video} from \"./session\";\nimport {IeeeVisDb} from \"./ieeevisdb\";\nimport {IeeeVisVideoPlayer} from \"./videoplayer\";\n\ntype PANEL_TAB = \"slido\" | \"discord\";\n\nclass IeeeVisStream {\n    static PLAYER_ELEMENT_ID = 'ytplayer';\n    static CONTENT_WRAPPER_ID = 'content';\n    static GATHERTOWN_WRAPPER_ID = 'gathertown';\n    static SESSION_ID = location.search.substr(location.search.indexOf('session=') + 'session='.length);\n\n    data: Session;\n    player: IeeeVisVideoPlayer;\n    db: IeeeVisDb;\n\n    width = window.innerWidth;\n    height = window.innerHeight;\n\n    CHAT_WIDTH_PERCENT = 40;\n    CHAT_PADDING_LEFT_PX = 20;\n    static HEADERS_HEIGHT = 40;\n\n    currentPanelTab: PANEL_TAB = \"discord\";\n\n    constructor() {\n        this.db = new IeeeVisDb(IeeeVisStream.SESSION_ID, this.onData.bind(this));\n        this.player = new IeeeVisVideoPlayer(IeeeVisStream.PLAYER_ELEMENT_ID,\n            this.getCurrentVideo.bind(this),\n            this.getCurrentVideoId.bind(this),\n            () => this.data?.currentStatus);\n        this.db.loadData();\n\n        this.loadGathertown();\n        this.initPanelTabs();\n\n        this.resize();\n        window.addEventListener('resize', this.resize.bind(this));\n    }\n\n    onYouTubeIframeAPIReady() {\n        this.player.onYouTubeIframeAPIReady();\n    }\n\n    loadChat() {\n        const discordUrl = `https://titanembeds.com/embed/851543399982170163?defaultchannel=${this.data.discord}`;\n        const rocketUrl = `https://chat.wushernet.com/channel/${this.data.rocketchat}?layout=embedded`;\n        const url = location.hash.indexOf('discord') === -1 ? rocketUrl : discordUrl;\n        const html = `<iframe src=\"${url}\" id=\"discord-iframe\" frameborder=\"0\"></iframe>`;\n        document.getElementById('discord-wrap').innerHTML += html;\n    }\n\n    loadSlido() {\n        const frame = document.getElementById('slido-frame');\n        frame.setAttribute('src', `https://app.sli.do/event/${this.data.slido}`);\n    }\n\n    loadGathertown() {\n        const html = `<iframe title=\"gather town\"\n                              allow=\"camera;microphone\"\n                              id=\"gathertown-iframe\"\n                              src=\"https://gather.town/app/aDeS7vVGW5A2wuF5/vis21-tech2\"></iframe>`;\n\n        const gatherWrap = document.getElementById(IeeeVisStream.GATHERTOWN_WRAPPER_ID);\n        gatherWrap.innerHTML = html;\n    }\n\n    onData(session: Session) {\n        const initializing = this.data === null || this.data === undefined;\n        const lastYtId = this.getCurrentVideoId();\n        this.data = session;\n\n        document.getElementById('track-title').innerText = this.data.name;\n        document.getElementById('video-name').innerText = this.getCurrentVideo()?.title;\n\n        if(this.getCurrentVideoId() != lastYtId) {\n            this.player.updateVideo();\n        }\n\n        if(initializing) {\n            this.loadChat();\n            this.loadSlido();\n        }\n        this.resize();\n    }\n\n    getCurrentVideo(): Video {\n        return this.data?.videos[this.data?.currentStatus?.videoIndex];\n    }\n\n    getCurrentVideoId() {\n        return this.getCurrentVideo()?.youtubeId;\n    }\n\n    initPanelTabs() {\n        const getToggle = (tabName: PANEL_TAB) => () => {\n            console.log(tabName);\n            this.currentPanelTab = tabName;\n            this.updatePanelTabs();\n        };\n\n        document.getElementById('discord-tab-link').onclick = getToggle('discord');\n        document.getElementById('slido-tab-link').onclick = getToggle('slido');\n    }\n\n    updatePanelTabs() {\n        document.getElementById('discord-tab-link').className = '';\n        document.getElementById('slido-tab-link').className = '';\n        document.getElementById(`${this.currentPanelTab}-tab-link`).className = 'active';\n\n        document.getElementById('discord-wrap').className = '';\n        document.getElementById('slido-wrap').className = '';\n        document.getElementById(`${this.currentPanelTab}-wrap`).className = 'active';\n    }\n\n    resize() {\n        this.width = window.innerWidth;\n        this.height = window.innerHeight - 65; // 40px for title\n\n        const state = this.getCurrentVideo()?.state;\n        const gathertownHeightPercent = state === \"SOCIALIZING\" ? 65 : 35;\n\n        const playerWidth = this.width * (100 - this.CHAT_WIDTH_PERCENT) / 100;\n        const playerHeight = (this.height - IeeeVisStream.HEADERS_HEIGHT * 2) * (100 - gathertownHeightPercent) / 100;\n        this.player.setSize(playerWidth, playerHeight);\n\n        const gatherFrame = document.getElementById('gathertown-iframe');\n        const gatherWidth = this.width * (100 - this.CHAT_WIDTH_PERCENT) / 100;\n        const gatherHeight=(this.height - IeeeVisStream.HEADERS_HEIGHT * 2) * gathertownHeightPercent / 100;\n        gatherFrame.setAttribute('width', `${gatherWidth}`);\n        gatherFrame.setAttribute('height', `${gatherHeight}`);\n\n        const contentWrap = document.getElementById(IeeeVisStream.CONTENT_WRAPPER_ID);\n        contentWrap.style.width = `${gatherWidth}px`;\n\n        this.currentPanelTab = state === \"QA\" ? \"slido\" : \"discord\";\n        this.updatePanelTabs();\n\n        const slidoFrame = document.getElementById('slido-frame');\n        if(slidoFrame) {\n            slidoFrame.setAttribute('width', `${this.width * this.CHAT_WIDTH_PERCENT / 100 - this.CHAT_PADDING_LEFT_PX}`);\n            slidoFrame.setAttribute('height', `${this.height - IeeeVisStream.HEADERS_HEIGHT}`);\n        }\n\n        const discordFrame = document.getElementById('discord-iframe');\n        if(discordFrame) {\n            discordFrame.setAttribute('width', `${this.width * this.CHAT_WIDTH_PERCENT / 100 - this.CHAT_PADDING_LEFT_PX}`);\n            discordFrame.setAttribute('height', `${this.height - IeeeVisStream.HEADERS_HEIGHT}`);\n        }\n    }\n}\n\nconst stream = new IeeeVisStream();\nexport declare var onYouTubeIframeAPIReady;\n\nonYouTubeIframeAPIReady = () => {\n    stream.onYouTubeIframeAPIReady();\n}"],
  "mappings": ";;AAIO,wBAAgB;AAAA,IAGnB,YAAoB,YAA4B,QAAoC;AAAhE;AAA4B;AAC5C,WAAK;AAAA;AAAA,IAGT,eAAe;AACX,eAAS,cAAc;AAAA,QACnB,QAAQ;AAAA,QACR,YAAY;AAAA,QACZ,aAAa;AAAA,QACb,WAAW;AAAA,QACX,eAAe;AAAA,QACf,mBAAmB;AAAA,QACnB,OAAO;AAAA,QACP,eAAe;AAAA;AAEnB,eAAS;AAAA;AAAA,IAGb,WAAW;AACP,WAAK,aAAa,SAAS,WAAW,IAAI,cAAc,KAAK;AAE7D,WAAK,WAAW,GAAG,SAAS,CAAC,aAAa;AACtC,aAAK,OAAO,SAAS;AAAA;AAAA;AAAA,IAI7B,IAAI,MAAc,OAAyB;AACvC,WAAK,WAAW,MAAM,MAAM,IAAI;AAAA;AAAA;;;ACrBjC,MAAK;AAAL,YAAK,cAAL;AACH,6CAAY,MAAZ;AACA,yCAAQ,KAAR;AACA,2CAAU,KAAV;AACA,0CAAS,KAAT;AACA,6CAAY,KAAZ;AACA,wCAAO,KAAP;AAAA,KANQ;;;ACRL,iCAAyB;AAAA,IAW5B,YAAoB,WACA,iBACA,mBACA,uBAA4C;AAH5C;AACA;AACA;AACA;AAZpB,0BAAe,IAAI;AAEX,mBAAQ;AACR,oBAAS;AAEjB,6BAAkB;AAClB,iCAAsB;AACtB,gCAAqB;AAMjB,WAAK;AAAA;AAAA,IAGT,0BAA0B;AACtB,WAAK,kBAAkB;AAAA;AAAA,IAG3B,cAAc;AACV,UAAG,CAAC,KAAK,uBAAuB,CAAC,KAAK,iBAAiB;AACnD;AAAA;AAGJ,UAAG,CAAC,KAAK,qBAAqB;AAC1B,aAAK;AAAA,aACF;AACH,aAAK;AAAA;AAAA;AAAA,IAIb,QAAQ,OAAe,QAAgB;AACnC,WAAK,QAAQ;AACb,WAAK,SAAS;AAEd,UAAG,CAAC,KAAK,QAAQ;AACb;AAAA;AAEJ,WAAK,OAAO,QAAQ,OAAO;AAAA;AAAA,IAGvB,OAAO;AACX,YAAM,MAAM,SAAS,cAAc;AACnC,UAAI,MAAM;AACV,YAAM,iBAAiB,SAAS,qBAAqB,UAAU;AAC/D,qBAAe,WAAW,aAAa,KAAK;AAAA;AAAA,IAGxC,gBAAgB;AACpB,cAAQ,IAAI,gBAAgB,KAAK;AACjC,WAAK,qBAAqB;AAE1B,UAAG,KAAK,aAAa,UAAU,aAAa;AACxC,aAAK,OAAO;AAAA;AAEhB,WAAK,OAAO;AAAA;AAAA,IAGR,oBAAoB,OAAmD;AAC3E,UAAG,MAAM,SAAS,YAAY,WAAW;AAErC,aAAK,OAAO,OAAO,KAAK,wBAAwB;AAAA;AAGpD,UAAG,MAAM,SAAS,YAAY,WAAW,MAAM,SAAS,YAAY,WAAW;AAC3E,cAAM,YAAY,KAAK;AACvB,cAAM,cAAc,KAAK,OAAO;AAChC,YAAG,KAAK,IAAI,YAAY,eAAe,GAAG;AACtC,eAAK,OAAO,OAAO,KAAK,wBAAwB;AAChD,kBAAQ,IAAI,yBAAyB,KAAK,wBAAwB,KAAK,OAAO;AAAA;AAAA;AAAA;AAAA,IAKlF,oBAAoB;AACxB,WAAK,sBAAsB;AAE3B,WAAK,SAAS,IAAI,GAAG,OAAO,KAAK,WAAW;AAAA,QACxC,OAAO,KAAK;AAAA,QACZ,QAAQ,KAAK;AAAA,QACb,SAAS,KAAK;AAAA,QAEd,YAAY;AAAA,UACR,eAAe;AAAA,UACf,YAAY;AAAA,UACZ,YAAY;AAAA,UACZ,OAAO;AAAA,UACP,kBAAkB;AAAA,UAClB,QAAQ;AAAA,UACR,OAAO,KAAK;AAAA;AAAA,QAEhB,QAAQ;AAAA,UACJ,WAAW,KAAK,cAAc,KAAK;AAAA,UACnC,iBAAiB,KAAK,oBAAoB,KAAK;AAAA;AAAA;AAAA;AAAA,IAKnD,qBAAqB;AAEzB,WAAK,OAAO,cAAc,KAAK,qBAAqB,KAAK;AACzD,WAAK,OAAO;AAAA;AAAA,IAGR,uBAAuB;AAC3B,UAAG,KAAK,kBAAkB,SAAS,iBAAiB,CAAC,KAAK,oBAAoB;AAC1E,cAAM,SAAS,IAAI,OAAO;AAC1B,cAAM,wBAAwB,KAAK,yBAAyB;AAE5D,eAAO,KAAK,MAAO,UAAS,yBAAyB;AAAA,iBAC/C,KAAK,kBAAkB,SAAS,QAAQ;AAC9C,eAAO,KAAK,OAAO;AAAA;AAAA;AAAA;;;ACjH/B,6BAAoB;AAAA,IAmBhB,cAAc;AATd,mBAAQ,OAAO;AACf,oBAAS,OAAO;AAEhB,gCAAqB;AACrB,kCAAuB;AAGvB,6BAA6B;AAGzB,WAAK,KAAK,IAAI,UAAU,eAAc,YAAY,KAAK,OAAO,KAAK;AACnE,WAAK,SAAS,IAAI,mBAAmB,eAAc,mBAC/C,KAAK,gBAAgB,KAAK,OAC1B,KAAK,kBAAkB,KAAK,OAC5B,MAAM,KAAK,MAAM;AACrB,WAAK,GAAG;AAER,WAAK;AACL,WAAK;AAEL,WAAK;AACL,aAAO,iBAAiB,UAAU,KAAK,OAAO,KAAK;AAAA;AAAA,IAGvD,0BAA0B;AACtB,WAAK,OAAO;AAAA;AAAA,IAGhB,WAAW;AACP,YAAM,aAAa,mEAAmE,KAAK,KAAK;AAChG,YAAM,YAAY,sCAAsC,KAAK,KAAK;AAClE,YAAM,MAAM,SAAS,KAAK,QAAQ,eAAe,KAAK,YAAY;AAClE,YAAM,OAAO,gBAAgB;AAC7B,eAAS,eAAe,gBAAgB,aAAa;AAAA;AAAA,IAGzD,YAAY;AACR,YAAM,QAAQ,SAAS,eAAe;AACtC,YAAM,aAAa,OAAO,4BAA4B,KAAK,KAAK;AAAA;AAAA,IAGpE,iBAAiB;AACb,YAAM,OAAO;AAAA;AAAA;AAAA;AAKb,YAAM,aAAa,SAAS,eAAe,eAAc;AACzD,iBAAW,YAAY;AAAA;AAAA,IAG3B,OAAO,SAAkB;AACrB,YAAM,eAAe,KAAK,SAAS,QAAQ,KAAK,SAAS;AACzD,YAAM,WAAW,KAAK;AACtB,WAAK,OAAO;AAEZ,eAAS,eAAe,eAAe,YAAY,KAAK,KAAK;AAC7D,eAAS,eAAe,cAAc,YAAY,KAAK,mBAAmB;AAE1E,UAAG,KAAK,uBAAuB,UAAU;AACrC,aAAK,OAAO;AAAA;AAGhB,UAAG,cAAc;AACb,aAAK;AACL,aAAK;AAAA;AAET,WAAK;AAAA;AAAA,IAGT,kBAAyB;AACrB,aAAO,KAAK,MAAM,OAAO,KAAK,MAAM,eAAe;AAAA;AAAA,IAGvD,oBAAoB;AAChB,aAAO,KAAK,mBAAmB;AAAA;AAAA,IAGnC,gBAAgB;AACZ,YAAM,YAAY,CAAC,YAAuB,MAAM;AAC5C,gBAAQ,IAAI;AACZ,aAAK,kBAAkB;AACvB,aAAK;AAAA;AAGT,eAAS,eAAe,oBAAoB,UAAU,UAAU;AAChE,eAAS,eAAe,kBAAkB,UAAU,UAAU;AAAA;AAAA,IAGlE,kBAAkB;AACd,eAAS,eAAe,oBAAoB,YAAY;AACxD,eAAS,eAAe,kBAAkB,YAAY;AACtD,eAAS,eAAe,GAAG,KAAK,4BAA4B,YAAY;AAExE,eAAS,eAAe,gBAAgB,YAAY;AACpD,eAAS,eAAe,cAAc,YAAY;AAClD,eAAS,eAAe,GAAG,KAAK,wBAAwB,YAAY;AAAA;AAAA,IAGxE,SAAS;AACL,WAAK,QAAQ,OAAO;AACpB,WAAK,SAAS,OAAO,cAAc;AAEnC,YAAM,QAAQ,KAAK,mBAAmB;AACtC,YAAM,0BAA0B,UAAU,gBAAgB,KAAK;AAE/D,YAAM,cAAc,KAAK,QAAS,OAAM,KAAK,sBAAsB;AACnE,YAAM,eAAgB,MAAK,SAAS,eAAc,iBAAiB,KAAM,OAAM,2BAA2B;AAC1G,WAAK,OAAO,QAAQ,aAAa;AAEjC,YAAM,cAAc,SAAS,eAAe;AAC5C,YAAM,cAAc,KAAK,QAAS,OAAM,KAAK,sBAAsB;AACnE,YAAM,eAAc,MAAK,SAAS,eAAc,iBAAiB,KAAK,0BAA0B;AAChG,kBAAY,aAAa,SAAS,GAAG;AACrC,kBAAY,aAAa,UAAU,GAAG;AAEtC,YAAM,cAAc,SAAS,eAAe,eAAc;AAC1D,kBAAY,MAAM,QAAQ,GAAG;AAE7B,WAAK,kBAAkB,UAAU,OAAO,UAAU;AAClD,WAAK;AAEL,YAAM,aAAa,SAAS,eAAe;AAC3C,UAAG,YAAY;AACX,mBAAW,aAAa,SAAS,GAAG,KAAK,QAAQ,KAAK,qBAAqB,MAAM,KAAK;AACtF,mBAAW,aAAa,UAAU,GAAG,KAAK,SAAS,eAAc;AAAA;AAGrE,YAAM,eAAe,SAAS,eAAe;AAC7C,UAAG,cAAc;AACb,qBAAa,aAAa,SAAS,GAAG,KAAK,QAAQ,KAAK,qBAAqB,MAAM,KAAK;AACxF,qBAAa,aAAa,UAAU,GAAG,KAAK,SAAS,eAAc;AAAA;AAAA;AAAA;AA7I/E;AACW,EADX,cACW,oBAAoB;AACpB,EAFX,cAEW,qBAAqB;AACrB,EAHX,cAGW,wBAAwB;AACxB,EAJX,cAIW,aAAa,SAAS,OAAO,OAAO,SAAS,OAAO,QAAQ,cAAc,WAAW;AAWrF,EAfX,cAeW,iBAAiB;AAmI5B,MAAM,SAAS,IAAI;AAGnB,4BAA0B,MAAM;AAC5B,WAAO;AAAA;",
  "names": []
}
